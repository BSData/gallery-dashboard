@using Humanizer

@inject GalleryHttpClient client
@inject GalleryBrowserState state

@if (CatpkgGallery is { InfoCache: { } galleryInfo })
{
    <FluentCard class="p-2">
        <h4>@galleryInfo.Name</h4>
        <em>@galleryInfo.Description</em>
        <ul>
            <li>
                Website URL: <a href="@galleryInfo.WebsiteUrl">@galleryInfo.WebsiteUrl</a>
            </li>
            <li>
                GitHub: <a href="@galleryInfo.GithubUrl">@galleryInfo.GithubUrl</a>
            </li>
            <li>
                Catpkg-Gallery JSON: <a href="@galleryInfo.RepositorySourceUrl">@galleryInfo.RepositorySourceUrl</a>
            </li>
            <li>
                Discord: <a href="@galleryInfo.DiscordUrl">@galleryInfo.DiscordUrl</a>
            </li>
            <li>
                Facebook: <a href="@galleryInfo.FacebookUrl">@galleryInfo.FacebookUrl</a>
            </li>
            <li>
                Twitter: <a href="@galleryInfo.TwitterUrl">@galleryInfo.TwitterUrl</a>
            </li>
            <li>
                Atom feed: <a href="@galleryInfo.FeedUrl">@galleryInfo.FeedUrl</a>
            </li>
        </ul>

        <FluentCheckbox @bind-Value=ShowArchived>
            Show Archived Repositories
        </FluentCheckbox>
    </FluentCard>

    var repoList = repositories;

    <FluentDataGrid RowsData=repoList TItem=CatpkgRepositoryInfo GenerateHeader=GenerateHeaderOption.Default
    ColumnDefinitions=ColumnDefinitions GridTemplateColumns="1fr 2fr">
        <RowItemTemplate>
            <FluentDataGridRow @onclick="() => OpenRepository(context)">
                <FluentDataGridCell GridColumn=1>
                    <p>
                        @* // TODO allow repository selection *@
                        <b>@context.Description</b>
                        @if (context.Archived is true)
                            {
                                <span class="ml-1">
                                    <FluentBadge Appearance="Appearance.Neutral">Archived</FluentBadge>
                                </span>
                            }
                            <br>

                            <FluentAnchor Href="@context.GithubUrl" Appearance=Appearance.Hypertext class="font-mono">
                                @context.Name
                            </FluentAnchor>
                        </p>
                    </FluentDataGridCell>
                    <FluentDataGridCell GridColumn=2>
                        <p>
                            <span class="font-mono">@context.Version</span>
                            <b>@context.LastUpdateDescription</b>
                            @if (context.LastUpdated is { } lastUpdated)
                            {
                                var offset = DateTimeOffset.Parse(lastUpdated);
                                <br>
                                <em>
                                    <time id="updateTime" datetime="@lastUpdated">@offset.Humanize()
                                        (@offset.ToLocalTime().ToString("u"))</time>
                                </em>
                            }
                        </p>
                    </FluentDataGridCell>
                </FluentDataGridRow>
            </RowItemTemplate>
        </FluentDataGrid>
}
else if (CatpkgGallery is null)
{
    <span>No gallery selected.</span>
}
else
{
    <FluentProgressRing />
    <p>Loading catpkg gallery...</p>
}

@code {
    [Parameter]
    public CatpkgGalleryCache? CatpkgGallery { get; set; }

    [Parameter]
    public EventCallback<CatpkgGalleryCache> CatpkgGalleryChanged { get; set; }

    bool showArchived;
    bool ShowArchived
    {
        get => showArchived;
        set
        {
            showArchived = value;
            UpdateRepositories();
        }
    }
    List<CatpkgRepositoryInfo>? repositories;
    List<ColumnDefinition<CatpkgRepositoryInfo>> ColumnDefinitions { get; } = new()
    {
#nullable disable
        new("Name", x => x.Description),
        new("Latest Release", x => x.Version),
#nullable restore
    };

    void UpdateRepositories()
    {
        repositories = CatpkgGallery?.InfoCache?.Repositories
        ?.Where(x => x.Archived is true ? ShowArchived : true)
        .OrderBy(x => x.Description)
        .ToList()
        ?? new();
    }

    void OpenRepository(CatpkgRepositoryInfo repoInfo)
    {
        Console.WriteLine($"clicked: {repoInfo.Name}");
    }

    protected async override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        if (CatpkgGallery is { Reference: { } galleryRef, InfoCache: null })
        {
            var result = await state.Cache.GetHydratedCatpkgGalleryCacheAsync(client, galleryRef);
            await CatpkgGalleryChanged.InvokeAsync(result);
        }
        UpdateRepositories();
    }
}
